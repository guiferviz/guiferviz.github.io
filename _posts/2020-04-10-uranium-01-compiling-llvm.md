---
layout: post

title: Uranium 01 - Compiling LLVM
excerpt: >
    Instructions for compiling and installing LLVM from git.
date: 2020-04-10
tags: [Compilers, Uranium, LLVM]

mathjax: false
comments: true
---

In the last post I introduced the Uranium project, the motivations around it
and some basic explanations around compilers.
So far so good, no radiation in the air.

Before using LLVM you need to install it.
Compiling LLVM was **easier than I expected**.
The most difficult part of this post was waiting until the end of the
compilation.
You only need patience (and *CMake* and a modern *C++ compiler* :).

The documentation specifies the requirements and the
[build and installation process][llvmInstall]
quite well.
Using [CMake for building][llvmCMake] the libraries is the easier way.
I know it is well described there, but anyways, I'm going to post here the
process with the exact commands I ran.

If you don't want to build your own binaries, you can use a **pre-build**
distribution if your platform is among those available.
I didn't try it, but I know it's an option.
I'm trying to build a compiler, so I prefer to compile it by myself :)

Clone *git* or download a package with an specific version.
For example, for installing the version 10.0.0 using git your should execute:
```cmd
git clone https://github.com/llvm/llvm-project.git
cd llvm-project
git checkout llvmorg-10.0.0
```

The version 10.0.0 was the last stable version at the time of writing.
You can explore the existing tags in the repository with `git tag -l`.
Choose the tag that correspond to the version you want to install.

Inside the `llvm-project` folder run:
```cmd
mkdir build
cd build
```

And now we need to generate the `Makefile`s using *CMake*.
We can pass several variables to CMake to change the generated build files.
Some of the options I used were:

* `CMAKE_INSTALL_PREFIX`: Where the libraries are going to be installed.
  By default they are installed in `/usr/local` but thinking about the future
  I preferred to create a separate directory for each version I had compile.
* As I said in the previous post, `clang` is the C++ compiler we are going to
  use.
  Apart from compile our compiler, `clang` is going to be very useful for
  comparing the generated IR code of our language to the one generated by an
  equivalent program written in C/C++.
  We'll use that as proof that we're generating proper code.
  To indicate that we want to build `clang` we need to add the project name
  to the variable `LLVM_ENABLE_PROJECTS`.

The line I ran was:
```cmd
cmake \
  -DCMAKE_INSTALL_PREFIX=/usr/local/llvm10 \
  -DLLVM_ENABLE_PROJECTS=clang \
  -G "Unix Makefiles" ../llvm
```

You can also compile `clang` later running again the `cmake` command with
`DLLVM_ENABLE_PROJECTS`.
You don't even need the repeat the `CMAKE_INSTALL_PREFIX` variable if you did
it before:
```cmd
cmake \
  -DLLVM_ENABLE_PROJECTS=clang \
  -G "Unix Makefiles" ../llvm
```

Compile the code just with a simple `make` command.
The compilation process for LLVM + clang takes around 4 hours in my computer.
```cmd
make
```

Once compiled, **install** the binaries.
If your install directory does not exists, you need to create it first.
```cmd
sudo mkdir /usr/local/llvm10
sudo make install
```

If you want to **build the documentation** you can re-execute the `cmake` with
the `LLVM_ENABLE_DOXYGEN` variable active.
I tried to build the documentation with *Sphynx* but I was getting an
"Warning treated as error" that didn't allow me to finish the docs generation.
*Doxygen* is working well for me:
```cmd
cmake \
  -DLLVM_ENABLE_DOXYGEN=On \
  -G "Unix Makefiles" ../llvm
make doxygen-llvm
sudo make install
```

Your documentation is ready in `build/docs/doxygen/html/index.html`.
If you install it, you can also find it in your install directory,
`<install-dir>/docs/html/html/index.html`.
For example, in my case it is in `/usr/local/llvm10/docs/html/html/index.html`.
Keep in mind that this documentation is only for the LLVM libraries and does
not include `clang` documentation or any other extra tutorials.
If you do not want to generate the documentation you can use the online
version.
Just be sure that you are using the documentation of the installed version of
LLVM to avoid confusions.
Search for the appropriate version of your documentation [here][llvmReleases].
For example, for the [version 10.0.0][llvm10docs] that I installed I need to
use the given link.


# Check the installation

Add the `bin` directory under your install folder to the `PATH` environment
variable if you want to use all the LLVM tools easily.
Add the following line to your `~/.bashrc` file:
```cmd
export PATH=$PATH:/usr/local/llvm10/bin
```

Using this approach you can easily select the version of LLVM you can use
in your projects.

Restart your *Shell* and execute `clang --version` and later `lli --version`.
The system should find the existing executable files and show the next output
for `clang --version`:
```cmd
clang version 10.0.0 (https://github.com/llvm/llvm-project.git d32170dbd5b0d54436537b6b75beaf44324e0c28)
Target: x86_64-unknown-linux-gnu
Thread model: posix
InstalledDir: /usr/local/llvm10/bin
```
and for `lli --version`:
```cmd
LLVM (http://llvm.org/):
  LLVM version 10.0.0
  DEBUG build with assertions.
  Default target: x86_64-unknown-linux-gnu
  Host CPU: skylake
```


# Next step

After compiling, installing and checking that the binaries are in the correct
path, we are going to **compile our first program using the LLVM libraries**.
For doing that we need a proper way to compile our code.
As LLVM, we are going to use CMake for generating our `Makefile`s.
See you in the [next post][nextPost]!!


# References

No more references, apart from the given links, are been used for this
post.
Here are all the links used in this page:

* [LLVM Install page][llvmInstall].
* [LLVM CMake page][llvmCMake].
* [LLVM Docs for the 10.0.0 version][llvm10docs].
* [All LLVM Releases][llvmReleases].


[llvmInstall]: https://llvm.org/docs/GettingStarted.html#getting-the-source-code-and-building-llvm
[llvmCMake]: https://llvm.org/docs/CMake.html
[llvm10docs]: https://releases.llvm.org/10.0.0/docs/index.html
[llvmReleases]: https://releases.llvm.org/
[nextPost]: /2020/04/11/uranium-02-ir-generation.html
[prevPost]: /2020/04/09/uranium-00-motivations.html

